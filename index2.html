<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buscador 4K (Multi-Fuente)</title>
  <meta name="description" content="Buscador de im√°genes 4K usando Pexels, Unsplash y Pixabay." />
  <style>
    :root{
      --bg:#0b1220; --text:#eaf0ff; --muted:#b7c3e6;
      --line:rgba(255,255,255,.12); --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(900px 600px at 20% 0%, #16305f 0%, transparent 60%),
                  radial-gradient(900px 600px at 80% 10%, #2a1456 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg), #050914 70%);
      min-height:100vh;
    }
    header{ padding: 28px 18px 18px; max-width: 1120px; margin: 0 auto; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:40px; height:40px; border-radius:12px;
      background: linear-gradient(135deg, #7c3aed, #06b6d4);
      box-shadow: var(--shadow);
    }
    h1{ margin:0; font-size: 22px; letter-spacing:.2px}
    .sub{ margin: 6px 0 0; color: var(--muted); font-size: 14px; line-height:1.4}
    main{ max-width: 1120px; margin: 0 auto; padding: 0 18px 36px; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .toolbar{
      padding: 14px; display:grid; grid-template-columns: 1fr; gap: 12px;
      background: rgba(255,255,255,.03); border-bottom: 1px solid var(--line);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .input{
      flex:1; min-width: 240px; display:flex; align-items:center; gap:10px;
      padding: 10px 12px; background: rgba(0,0,0,.25);
      border: 1px solid var(--line); border-radius: 12px;
    }
    .input input{ flex:1; background: transparent; border:none; outline:none; color: var(--text); font-size: 14px; }
    .pill{
      display:flex; align-items:center; gap:8px; padding: 9px 10px;
      border-radius: 12px; border: 1px solid var(--line);
      background: rgba(0,0,0,.22); color: var(--muted); font-size: 13px;
    }
    select{ background: transparent; color: var(--text); border:none; outline:none; font-size: 13px; }
    option{ color:#111; }
    button{
      cursor:pointer; border:none; border-radius: 12px; padding: 10px 14px;
      color: white; background: linear-gradient(135deg, #7c3aed, #06b6d4);
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      font-weight: 600; font-size: 14px;
      transition: transform .08s ease, opacity .2s ease;
    }
    button:active{ transform: scale(.98); }
    button.secondary{ background: rgba(255,255,255,.06); border: 1px solid var(--line); color: var(--text); box-shadow:none; }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .meta{
      padding: 12px 14px; display:flex; justify-content: space-between; gap: 12px;
      align-items:center; flex-wrap: wrap; color: var(--muted); font-size: 13px;
    }
    .status{ display:flex; align-items:center; gap:10px; }
    .dot{ width:10px; height:10px; border-radius:99px; background:#22c55e; box-shadow:0 0 0 4px rgba(34,197,94,.18); }
    .dot.warn{ background:#f59e0b; box-shadow:0 0 0 4px rgba(245,158,11,.18); }
    .dot.err{ background:#ef4444; box-shadow:0 0 0 4px rgba(239,68,68,.18); }

    .grid{
      padding: 14px;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
    }
    .tile{
      position: relative;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      min-height: 180px;
      padding:0;
      cursor:pointer;
    }
    .tile img{
      width:100%;
      height: 220px;
      object-fit: cover;
      display:block;
      background: #0a0f1d;
      filter: saturate(1.05);
      transition: transform .25s ease;
    }
    .tile:hover img{ transform: scale(1.02); }
    .badge{
      position:absolute; left:10px; top:10px;
      font-size: 12px; padding: 6px 9px; border-radius: 999px;
      color: var(--text); background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.16); backdrop-filter: blur(10px);
    }
    .badge2{
      position:absolute; right:10px; top:10px;
      font-size: 12px; padding: 6px 9px; border-radius: 999px;
      color: var(--text); background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.16); backdrop-filter: blur(10px);
      text-transform: uppercase;
      opacity:.95;
    }
    .caption{
      position:absolute; left:10px; right:10px; bottom:10px;
      display:flex; justify-content: space-between; align-items:center; gap:8px;
      font-size: 12px; color: var(--text);
    }
    .caption .author{
      opacity:.9; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; max-width: 70%;
    }
    .link{
      color: var(--text); opacity:.9; text-decoration:none;
      padding: 6px 10px; border-radius: 999px;
      background: rgba(0,0,0,.45); border: 1px solid rgba(255,255,255,.16);
    }
    .actions{ padding: 0 14px 14px; display:flex; justify-content: center; }

    /* Modal */
    .modal{
      position: fixed; inset: 0; background: rgba(0,0,0,.62);
      display:none; align-items:center; justify-content:center; padding: 18px; z-index: 10;
    }
    .modal.open{ display:flex; }
    .modal-card{
      width:min(980px, 100%);
      border-radius: 18px; overflow:hidden;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
    }
    .modal-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 12px 14px; border-bottom: 1px solid var(--line);
      background: rgba(0,0,0,.18);
    }
    .modal-title{
      font-size: 14px; color: var(--muted);
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis; max-width: 70%;
    }
    .modal-body{ display:grid; grid-template-columns: 1.3fr .7fr; gap: 0; }
    .modal-body img{
      width:100%; height: min(70vh, 620px);
      object-fit: contain; background: rgba(0,0,0,.25); display:block;
    }
    .side{
      padding: 14px; border-left: 1px solid var(--line);
      background: rgba(0,0,0,.16); display:flex; flex-direction: column; gap: 10px;
    }
    .kv{ font-size: 13px; color: var(--muted); line-height:1.5; }
    .kv b{ color: var(--text); }
    .side .btns{ display:flex; flex-wrap:wrap; gap:10px; margin-top: 6px; }
    @media (max-width: 860px){
      .modal-body{ grid-template-columns: 1fr; }
      .side{ border-left:none; border-top: 1px solid var(--line); }
      .modal-body img{ height: min(60vh, 520px); }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Buscador de Im√°genes 4K</h1>
        <p class="sub">Busca en Pexels, Unsplash y Pixabay. Filtra por resoluci√≥n y descarga el original.</p>
      </div>
    </div>
  </header>

  <main>
    <section class="card" aria-label="Buscador">
      <div class="toolbar">
        <div class="row">
          <div class="input" title="T√©rmino de b√∫squeda">
            <span aria-hidden="true">üîé</span>
            <input id="q" placeholder="Ej: paisajes, navidad, perros, ciudad noche..." autocomplete="off" />
          </div>

          <div class="pill" title="Fuente">
            <span aria-hidden="true">üåê</span>
            <span>Fuente:</span>
            <select id="source">
              <option value="pexels" selected>Pexels</option>
              <option value="unsplash">Unsplash</option>
              <option value="pixabay">Pixabay</option>
              <option value="all">Todas</option>
            </select>
          </div>

          <div class="pill" title="Tama√±o m√≠nimo">
            <span aria-hidden="true">üñºÔ∏è</span>
            <span>M√≠nimo:</span>
            <select id="minSize">
              <option value="4k" selected>4K (3840√ó2160)</option>
              <option value="uhd">UHD+ (4096√ó2160)</option>
              <option value="8k">8K (7680√ó4320)</option>
            </select>
          </div>

          <div class="pill" title="Orientaci√≥n">
            <span aria-hidden="true">‚ÜîÔ∏è</span>
            <span>Orientaci√≥n:</span>
            <select id="orientation">
              <option value="any" selected>Cualquiera</option>
              <option value="landscape">Horizontal</option>
              <option value="portrait">Vertical</option>
              <option value="square">Cuadrada</option>
            </select>
          </div>

          <button id="btnSearch">Buscar</button>
          <button id="btnClear" class="secondary" type="button">Limpiar</button>
        </div>
      </div>

      <div class="meta">
        <div class="status" id="status">
          <span class="dot warn" id="dot"></span>
          <span id="statusText">Listo para buscar.</span>
        </div>
        <div id="countText"></div>
      </div>

      <div class="grid" id="grid" aria-live="polite"></div>

      <div class="actions">
        <button id="btnMore" class="secondary" disabled>Cargar m√°s</button>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-label="Vista previa">
    <div class="modal-card">
      <div class="modal-top">
        <div class="modal-title" id="modalTitle"></div>
        <div class="btns">
          <button id="btnDownload" type="button">Descargar</button>
          <button id="btnOpen" class="secondary" type="button">Abrir original</button>
          <button id="btnClose" class="secondary" type="button">Cerrar</button>
        </div>
      </div>
      <div class="modal-body">
        <img id="modalImg" alt="Vista previa" />
        <div class="side">
          <div class="kv"><b>Resoluci√≥n:</b> <span id="kvRes"></span></div>
          <div class="kv"><b>Autor:</b> <span id="kvAuthor"></span></div>
          <div class="kv"><b>Fuente:</b> <span id="kvSource"></span></div>
          <div class="kv" style="opacity:.9;">Tip: ‚ÄúDescargar‚Äù abre el original para guardarlo en m√°xima calidad.</div>
          <div class="btns">
            <button id="btnCopy" type="button">Copiar link</button>
            <button id="btnPage" class="secondary" type="button">Ver p√°gina</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ================== KEYS ==================
    const PEXELS_API_KEY = "tui3H5Y4gKK5OPwSRmclZq7rnDaJ4ALBrm0rpCUVvzNZ5RJaMPdy7jUw";
    const UNSPLASH_ACCESS_KEY = "TU_UNSPLASH_KEY_AQUI";
    const PIXABAY_API_KEY = "53848166-26aff801edb46b0b51ca904f7";

    const PER_PAGE = 30;

    const SIZE_PRESETS = {
      "4k":  { w: 3840, h: 2160 },
      "uhd": { w: 4096, h: 2160 },
      "8k":  { w: 7680, h: 4320 },
    };

    // ================== UI ==================
    const q = document.getElementById("q");
    const grid = document.getElementById("grid");
    const btnSearch = document.getElementById("btnSearch");
    const btnClear = document.getElementById("btnClear");
    const btnMore = document.getElementById("btnMore");
    const statusText = document.getElementById("statusText");
    const countText = document.getElementById("countText");
    const dot = document.getElementById("dot");
    const minSizeSel = document.getElementById("minSize");
    const orientationSel = document.getElementById("orientation");
    const sourceSel = document.getElementById("source");

    const modal = document.getElementById("modal");
    const modalImg = document.getElementById("modalImg");
    const modalTitle = document.getElementById("modalTitle");
    const kvRes = document.getElementById("kvRes");
    const kvAuthor = document.getElementById("kvAuthor");
    const kvSource = document.getElementById("kvSource");
    const btnClose = document.getElementById("btnClose");
    const btnOpen = document.getElementById("btnOpen");
    const btnDownload = document.getElementById("btnDownload");
    const btnCopy = document.getElementById("btnCopy");
    const btnPage = document.getElementById("btnPage");

    let page = 1;
    let lastQuery = "";
    let lastResultsCount = 0;
    let currentModalPhoto = null;

    function setStatus(type, text){
      statusText.textContent = text;
      dot.className = "dot" + (type === "ok" ? "" : type === "warn" ? " warn" : " err");
    }

    function isMinSize(item, preset){
      const { w, h } = SIZE_PRESETS[preset];
      return item.width >= w && item.height >= h;
    }

    function matchesOrientation(item, ori){
      if (ori === "any") return true;
      const w = item.width, h = item.height;
      if (ori === "landscape") return w > h;
      if (ori === "portrait") return h > w;
      if (ori === "square") return w === h;
      return true;
    }

    function clearGrid(){
      grid.innerHTML = "";
      countText.textContent = "";
      lastResultsCount = 0;
    }

    function tile(item){
      const el = document.createElement("button");
      el.type = "button";
      el.className = "tile";
      el.title = "Click para ver";
      el.style.textAlign = "left";

      const img = document.createElement("img");
      img.loading = "lazy";
      img.src = item.src.preview;
      img.alt = item.alt || "Imagen";

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = `${item.width}√ó${item.height}`;

      const badge2 = document.createElement("div");
      badge2.className = "badge2";
      badge2.textContent = item.source;

      const cap = document.createElement("div");
      cap.className = "caption";

      const author = document.createElement("div");
      author.className = "author";
      author.textContent = item.author || "Autor";

      const link = document.createElement("span");
      link.className = "link";
      link.textContent = "Ver";

      cap.appendChild(author);
      cap.appendChild(link);

      el.appendChild(img);
      el.appendChild(badge);
      el.appendChild(badge2);
      el.appendChild(cap);

      el.addEventListener("click", () => openModal(item));
      return el;
    }

    function openModal(item){
      currentModalPhoto = item;
      modalTitle.textContent = item.alt?.trim() ? item.alt : "Vista previa";
      modalImg.src = item.src.original;
      kvRes.textContent = `${item.width}√ó${item.height}`;
      kvAuthor.textContent = item.author || "-";
      kvSource.textContent = item.source;
      modal.classList.add("open");
    }

    function closeModal(){
      modal.classList.remove("open");
      modalImg.src = "";
      currentModalPhoto = null;
    }

    btnClose.addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modal.classList.contains("open")) closeModal();
    });

    btnOpen.addEventListener("click", () => {
      if (!currentModalPhoto) return;
      window.open(currentModalPhoto.src.original, "_blank", "noopener");
    });

    // Descargar: abre un enlace pensado para descargar (cuando existe), si no usa el original
    btnDownload.addEventListener("click", () => {
      if (!currentModalPhoto) return;
      const url = currentModalPhoto.downloadUrl || currentModalPhoto.src.original;
      window.open(url, "_blank", "noopener");
    });

    btnPage.addEventListener("click", () => {
      if (!currentModalPhoto?.pageUrl) return;
      window.open(currentModalPhoto.pageUrl, "_blank", "noopener");
    });

    btnCopy.addEventListener("click", async () => {
      if (!currentModalPhoto) return;
      try{
        await navigator.clipboard.writeText(currentModalPhoto.src.original);
        btnCopy.textContent = "¬°Copiado!";
        setTimeout(()=> btnCopy.textContent = "Copiar link", 900);
      }catch{
        alert("No pude copiar. Copia manualmente desde 'Abrir original'.");
      }
    });

    // ================== FETCHERS (NORMALIZADOS) ==================
    // Esquema unificado:
    // { id, source, width, height, author, alt, pageUrl, downloadUrl, src:{preview, original} }

    async function searchPexels(term, pageNum){
      if (!PEXELS_API_KEY || PEXELS_API_KEY.includes("AQUI")) throw new Error("Falta PEXELS_API_KEY.");
      const url = new URL("https://api.pexels.com/v1/search");
      url.searchParams.set("query", term);
      url.searchParams.set("per_page", String(PER_PAGE));
      url.searchParams.set("page", String(pageNum));

      const res = await fetch(url, { headers: { Authorization: PEXELS_API_KEY } });
      if (!res.ok) throw new Error(`Pexels error ${res.status}.`);
      const data = await res.json();

      return (data.photos || []).map(p => ({
        id: String(p.id),
        source: "pexels",
        width: p.width,
        height: p.height,
        author: p.photographer,
        alt: p.alt || "",
        pageUrl: p.url,
        downloadUrl: p.src?.original,   // para este caso igual que original
        src: {
          preview: p.src?.large || p.src?.medium,
          original: p.src?.original
        }
      }));
    }

    async function searchUnsplash(term, pageNum){
      if (!UNSPLASH_ACCESS_KEY || UNSPLASH_ACCESS_KEY.includes("AQUI")) throw new Error("Falta UNSPLASH_ACCESS_KEY.");
      const url = new URL("https://api.unsplash.com/search/photos");
      url.searchParams.set("query", term);
      url.searchParams.set("per_page", String(PER_PAGE));
      url.searchParams.set("page", String(pageNum));

      const res = await fetch(url, {
        headers: { Authorization: `Client-ID ${UNSPLASH_ACCESS_KEY}` }
      });
      if (!res.ok) throw new Error(`Unsplash error ${res.status}.`);
      const data = await res.json();

      return (data.results || []).map(p => ({
        id: String(p.id),
        source: "unsplash",
        width: p.width,
        height: p.height,
        author: p.user?.name || p.user?.username || "",
        alt: p.alt_description || p.description || "",
        pageUrl: p.links?.html,
        // Endpoint de descarga (recomendado por Unsplash): redirige al archivo final
        downloadUrl: p.links?.download_location
          ? `${p.links.download_location}&client_id=${UNSPLASH_ACCESS_KEY}`
          : p.links?.download,
        src: {
          preview: p.urls?.regular || p.urls?.small,
          original: p.urls?.full || p.urls?.raw
        }
      }));
    }

    async function searchPixabay(term, pageNum){
      if (!PIXABAY_API_KEY || PIXABAY_API_KEY.includes("AQUI")) throw new Error("Falta PIXABAY_API_KEY.");
      const url = new URL("https://pixabay.com/api/");
      url.searchParams.set("key", PIXABAY_API_KEY);
      url.searchParams.set("q", term);
      url.searchParams.set("image_type", "photo");
      url.searchParams.set("per_page", String(PER_PAGE));
      url.searchParams.set("page", String(pageNum));
      url.searchParams.set("safesearch", "true");

      const res = await fetch(url);
      if (!res.ok) throw new Error(`Pixabay error ${res.status}.`);
      const data = await res.json();

      return (data.hits || []).map(p => ({
        id: String(p.id),
        source: "pixabay",
        width: p.imageWidth,
        height: p.imageHeight,
        author: p.user,
        alt: p.tags || "",
        pageUrl: p.pageURL,
        // Pixabay a veces da "largeImageURL" (bueno para abrir/descargar)
        downloadUrl: p.largeImageURL || p.fullHDURL || p.webformatURL,
        src: {
          preview: p.webformatURL,
          original: p.largeImageURL || p.fullHDURL || p.webformatURL
        }
      }));
    }

    function dedupe(items){
      const seen = new Set();
      const out = [];
      for (const it of items){
        const key = (it.src?.original || "") + "|" + it.source + "|" + it.id;
        if (seen.has(key)) continue;
        seen.add(key);
        out.push(it);
      }
      // ordena por √°rea (m√°s grande primero)
      out.sort((a,b) => (b.width*b.height) - (a.width*a.height));
      return out;
    }

    async function fetchBySource(source, term, pageNum){
      if (source === "pexels") return searchPexels(term, pageNum);
      if (source === "unsplash") return searchUnsplash(term, pageNum);
      if (source === "pixabay") return searchPixabay(term, pageNum);

      // Todas: mezcla resultados (si una falla, las otras siguen)
      const results = await Promise.allSettled([
        searchPexels(term, pageNum),
        searchUnsplash(term, pageNum),
        searchPixabay(term, pageNum),
      ]);

      const ok = [];
      const fails = [];
      for (const r of results){
        if (r.status === "fulfilled") ok.push(...r.value);
        else fails.push(r.reason?.message || "Error desconocido");
      }

      if (ok.length === 0){
        throw new Error("No se pudo obtener resultados. Revisa tus API keys.");
      }

      if (fails.length){
        // No bloquea, solo avisa
        setStatus("warn", "Algunas fuentes fallaron, pero otras funcionaron.");
      }

      return ok;
    }

    // ================== SEARCH FLOW ==================
    async function search(reset = true){
      const term = q.value.trim();
      if (!term){
        setStatus("warn", "Escribe algo para buscar.");
        return;
      }

      const source = sourceSel.value;
      const preset = minSizeSel.value;
      const ori = orientationSel.value;

      if (reset){
        page = 1;
        clearGrid();
        lastQuery = term;
      }

      btnSearch.disabled = true;
      btnMore.disabled = true;
      setStatus("warn", "Buscando...");
      countText.textContent = "";

      try{
        const items = await fetchBySource(source, lastQuery, page);

        const filtered = dedupe(items)
          .filter(it => isMinSize(it, preset))
          .filter(it => matchesOrientation(it, ori))
          // aseguramos links
          .filter(it => it.src?.preview && it.src?.original);

        filtered.forEach(it => grid.appendChild(tile(it)));
        lastResultsCount += filtered.length;

        // Si la fuente devuelve ‚Äú0‚Äù a partir de aqu√≠, igual dejamos que intente ‚Äúcargar m√°s‚Äù
        btnMore.disabled = false;

        if (lastResultsCount === 0){
          setStatus("warn", "No encontr√© resultados con esos filtros. Prueba otro t√©rmino o baja el m√≠nimo.");
        } else {
          setStatus("ok", "Listo.");
        }

        countText.textContent = `Mostrando: ${lastResultsCount} ¬∑ P√°gina: ${page} ¬∑ Fuente: ${source.toUpperCase()}`;

      }catch(err){
        setStatus("err", err.message || "Ocurri√≥ un error.");
      }finally{
        btnSearch.disabled = false;
      }
    }

    btnSearch.addEventListener("click", () => search(true));
    btnMore.addEventListener("click", () => { page += 1; search(false); });
    btnClear.addEventListener("click", () => {
      q.value = "";
      page = 1;
      lastQuery = "";
      clearGrid();
      setStatus("warn", "Listo para buscar.");
      btnMore.disabled = true;
    });

    q.addEventListener("keydown", (e) => {
      if (e.key === "Enter"){
        e.preventDefault();
        search(true);
      }
    });

    q.focus();
  </script>
</body>
</html>
